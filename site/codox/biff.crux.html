<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>biff.crux documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>biff</span></div></div></li><li class="depth-2 branch current"><a href="biff.crux.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>crux</span></div></a></li><li class="depth-2"><a href="biff.dev.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dev</span></div></a></li><li class="depth-3"><a href="biff.dev.girouette.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>girouette</span></div></a></li><li class="depth-2 branch"><a href="biff.middleware.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-2 branch"><a href="biff.misc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>misc</span></div></a></li><li class="depth-2 branch"><a href="biff.rum.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rum</span></div></a></li><li class="depth-2"><a href="biff.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><a href="biff.util.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="biff.crux.html#var-authorize"><div class="inner"><span>authorize</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-biff-q"><div class="inner"><span>biff-q</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-check-read"><div class="inner"><span>check-read</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-check-write"><div class="inner"><span>check-write</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-get-changes"><div class="inner"><span>get-changes</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-get-tx-info"><div class="inner"><span>get-tx-info</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-handle-subscribe-event.21"><div class="inner"><span>handle-subscribe-event!</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-lazy-q"><div class="inner"><span>lazy-q</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-normalize-tx-doc"><div class="inner"><span>normalize-tx-doc</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-q-entity"><div class="inner"><span>q-entity</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-start-node"><div class="inner"><span>start-node</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-submit-tx"><div class="inner"><span>submit-tx</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-use-crux"><div class="inner"><span>use-crux</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-use-crux-sub-notifier"><div class="inner"><span>use-crux-sub-notifier</span></div></a></li><li class="depth-1"><a href="biff.crux.html#var-wrap-db"><div class="inner"><span>wrap-db</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">biff.crux</h1><div class="doc"><pre class="plaintext">Helper functions for Crux.

Also includes "Biff transactions" and "Biff queries", both of which are
patterned after Firebase's. Biff transactions provide a higher level
interface over crux.api/start-node. Biff queries are less
powerful than crux.api/q, but they support subscriptions (efficiently).</pre></div><div class="public anchor" id="var-authorize"><h3>authorize</h3><h4 class="type">multimethod</h4><div class="usage"></div><div class="doc"><pre class="plaintext">Extend this multimethod to provide authorization rules.

See <a href="https://biff.findka.com/#authorization-rules">https://biff.findka.com/#authorization-rules</a></pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L163">view source</a></div></div><div class="public anchor" id="var-biff-q"><h3>biff-q</h3><div class="usage"><code>(biff-q {:keys [biff.crux/db biff.crux/fn-whitelist], :as sys} {:keys [id where doc-type], :as query})</code></div><div class="doc"><pre class="plaintext">Executes a Biff query.

db:           A delayed Crux DB.
fn-whitelist: A collection of symbols for functions that are allowed to run
              in the Crux query. Symbols for non-core functions must be
              fully-qualified.
query:        See <a href="https://biff.findka.com/#subscription-query-format">https://biff.findka.com/#subscription-query-format</a>.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L562">view source</a></div></div><div class="public anchor" id="var-check-read"><h3>check-read</h3><div class="usage"><code>(check-read sys {:keys [docs query db]})</code></div><div class="doc"><pre class="plaintext">Checks if a read operation passes authorization rules.

Returns nil on success, otherwise returns the first unauthorized document.

query: See <a href="https://biff.findka.com/#subscription-query-format">https://biff.findka.com/#subscription-query-format</a></pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L174">view source</a></div></div><div class="public anchor" id="var-check-write"><h3>check-write</h3><div class="usage"><code>(check-write sys tx-info)</code></div><div class="doc"><pre class="plaintext">Checks if a write operation passes authorization rules.

Returns nil on success, otherwise returns the first unauthorized change (see
get-changes).

tx-info: See get-tx-info.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L197">view source</a></div></div><div class="public anchor" id="var-get-changes"><h3>get-changes</h3><div class="usage"><code>(get-changes {:keys [db server-timestamp biff-tx random-uuids]})</code></div><div class="doc"><pre class="plaintext">Return a list of changes that will occur after a transaction.

See <a href="https://biff.findka.com/#tx-docs">https://biff.findka.com/#tx-docs</a>.

server-timestamp: A Date object.
random-uuids:     A list of UUIDs to use for new documents.
biff-tx:          See <a href="https://biff.findka.com/#transactions">https://biff.findka.com/#transactions</a>.
db:               A Crux DB.

Each change is a map with the following keys:
:before   - The affected document's current value.
:after    - The affected document's value after the transaction occurs.
:tx-item  - An element of biff-tx.
:doc-type
:doc-id</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L277">view source</a></div></div><div class="public anchor" id="var-get-tx-info"><h3>get-tx-info</h3><div class="usage"><code>(get-tx-info {:keys [biff/schema biff.crux/db]} biff-tx)</code></div><div class="doc"><pre class="plaintext">Return a map with information needed to authorize and run a transaction.

schema:  An implementation of biff.util.protocols/Schema.
db:      A delayed Crux DB.
biff-tx: See <a href="https://biff.findka.com/#transactions">https://biff.findka.com/#transactions</a>.

Returns the following keys:
:crux-tx            - A Crux transaction.
:changes            - See get-changes.
:server-timestamp   - A Date object.
:db-before          - @db.
:db-after           - (crux.api/with-tx @db crux-tx).</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L318">view source</a></div></div><div class="public anchor" id="var-handle-subscribe-event.21"><h3>handle-subscribe-event!</h3><div class="usage"><code>(handle-subscribe-event! {event-id :id, {:keys [query action]} :?data, :keys [client-id biff.crux/subscriptions biff/uid biff.sente/send-fn], :as sys})</code></div><div class="doc"><pre class="plaintext">Sends query results to the client and subscribes them to future changes.

See use-crux-sub-notifier and <a href="https://biff.findka.com/#subscriptions">https://biff.findka.com/#subscriptions</a>.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L604">view source</a></div></div><div class="public anchor" id="var-lazy-q"><h3>lazy-q</h3><div class="usage"><code>(lazy-q db query f)</code></div><div class="doc"><pre class="plaintext">Calls crux.api/open-q and passes a lazy seq of the results to f.

f must process the results eagerly.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L138">view source</a></div></div><div class="public anchor" id="var-normalize-tx-doc"><h3>normalize-tx-doc</h3><div class="usage"><code>(normalize-tx-doc {:keys [server-timestamp doc-id tx-doc before]})</code></div><div class="doc"><pre class="plaintext">Converts a TX doc to a Crux doc.

server-timestamp: A Date object.
doc-id:           The Crux document ID.
before:           The Crux document's current value (i.e. before the
                  transaction). nil if the document is being created.
tx-doc:           See <a href="https://biff.findka.com/#transactions">https://biff.findka.com/#transactions</a>.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L234">view source</a></div></div><div class="public anchor" id="var-q-entity"><h3>q-entity</h3><div class="usage"><code>(q-entity db kvs)</code></div><div class="doc"><pre class="plaintext">Retrieve the first document that matches a set of kv pairs.

Example:

(q-entity db [[:user/email "foo@example.com"]])
=&gt; {:xt/id #uuid "some-uuid"
    :user/email "foo@example.com"}</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L146">view source</a></div></div><div class="public anchor" id="var-start-node"><h3>start-node</h3><div class="usage"><code>(start-node {:keys [topology dir opts jdbc-spec pool-opts]})</code></div><div class="doc"><pre class="plaintext">A higher-level version of crux.api/start-node.

Calls crux.api/sync before returning the node.

topology   - One of #{:standalone :jdbc}.
dir        - A path to store RocksDB instances in.
jdbc-spec,
pool-opts  - Maps to pass as
             {:xtdb.jdbc/connection-pool
              {:db-spec jdbc-spec :pool-opts pool-opts ...}}.
             (Used only when topology is :jdbc).
opts       - Additional options to pass to xtdb.api/start-node.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L69">view source</a></div></div><div class="public anchor" id="var-submit-tx"><h3>submit-tx</h3><div class="usage"><code>(submit-tx {:biff.crux/keys [node authorize], :as sys} biff-tx)</code></div><div class="doc"><pre class="plaintext">Submits a Biff transaction.

node:      A Crux node.
authorize: true if the transaction is required to pass authorization rules
           (default false).
biff-tx:   See <a href="https://biff.findka.com/#transactions">https://biff.findka.com/#transactions</a>.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L374">view source</a></div></div><div class="public anchor" id="var-use-crux"><h3>use-crux</h3><div class="usage"><code>(use-crux {:biff.crux/keys [topology dir opts], :as sys})</code></div><div class="doc"><pre class="plaintext">A Biff component for Crux.

Sets :biff.crux/node to the crux node.

topology,
dir,
opts                  - passed to start-node.
biff.crux.jdbc/*      - passed to start-node as jdbc-spec, without the namespace.
biff.crux.jdbc-pool/* - passed to start-node as pool-opts, without the namespace.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L109">view source</a></div></div><div class="public anchor" id="var-use-crux-sub-notifier"><h3>use-crux-sub-notifier</h3><div class="usage"><code>(use-crux-sub-notifier {:keys [biff.sente/connected-uids biff.crux/node], :as sys})</code></div><div class="doc"><pre class="plaintext">Sends new query results to subscribed clients.

See <a href="https://biff.findka.com/#subscription-interface">https://biff.findka.com/#subscription-interface</a>.

Sets :biff.crux/subscriptions to (atom #{}). To add subscriptions, insert
maps with these keys:
:biff/uid  - The subscriber's UID.
:client-id - The subscriber's Sente client ID.
:event-id  - The Sente event ID used to send this transaction.
:query     - The Biff query (see <a href="https://biff.findka.com/#subscription-query-format)">https://biff.findka.com/#subscription-query-format)</a>

Adds a watch to connected-uids and removes subscriptions if their clients
disconnect.</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L514">view source</a></div></div><div class="public anchor" id="var-wrap-db"><h3>wrap-db</h3><div class="usage"><code>(wrap-db handler {:keys [node]})</code></div><div class="doc"><pre class="plaintext">Sets :biff.crux/db to a delayed db value on incoming requests.
</pre></div><div class="src-link"><a href="https://github.com/modelingcooperation/biff/blob/a4341741103e2fe13fe0933468ed2af862ea01a7/libs/crux/src/biff/crux.clj#L131">view source</a></div></div></div></body></html>